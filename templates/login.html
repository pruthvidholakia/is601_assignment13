{% extends "layout.html" %}

{% block title %}Login{% endblock %}

{% block content %}
<div class="flex items-center justify-center min-h-screen bg-gray-100 px-4">
  <div class="w-full max-w-md bg-white shadow-xl rounded-2xl p-8 animate-fade-in">
    <h2 class="text-3xl font-extrabold text-center mb-6 text-gray-800">Welcome Back</h2>

    <!-- Alert for errors -->
    <div id="errorAlert" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4"
      role="alert">
      <span id="errorMessage" class="block sm:inline"></span>
    </div>

    <!-- Alert for success -->
    <div id="successAlert" class="hidden bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-4"
      role="alert">
      <span id="successMessage" class="block sm:inline"></span>
    </div>

    <form id="loginForm" class="space-y-5" onsubmit="return false;">
      <div>
        <label for="username" class="block text-sm font-medium text-gray-700">Username</label>
        <input type="text" id="username" name="username" required
          class="mt-1 w-full rounded-md border-gray-300 shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
      </div>

      <div>
        <label for="password" class="block text-sm font-medium text-gray-700">Password</label>
        <input type="password" id="password" name="password" required
          class="mt-1 w-full rounded-md border-gray-300 shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
      </div>

      <div class="flex items-center justify-between text-sm">
        <label class="flex items-center gap-2">
          <input id="remember" name="remember" type="checkbox"
            class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
          Remember me
        </label>
        <a href="#" class="text-indigo-600 hover:underline">Forgot password?</a>
      </div>

      <button type="submit"
        class="w-full py-2 px-4 bg-indigo-600 hover:bg-indigo-700 text-white font-medium rounded-md shadow">
        Sign in
      </button>

      <p class="text-sm text-center mt-4 text-gray-600">
        Don't have an account?
        <a href="/register" class="text-indigo-600 hover:underline">Register now</a>
      </p>
    </form>
  </div>
</div>

<style>
  @keyframes fade-in {
    from {
      opacity: 0;
      transform: translateY(10px);
    }

    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .animate-fade-in {
    animation: fade-in 0.6s ease-out;
  }
</style>

<script>
  // Wait for DOM to be fully loaded
  document.addEventListener('DOMContentLoaded', function () {
    // Get form and alert elements
    const form = document.getElementById('loginForm');
    const errorAlert = document.getElementById('errorAlert');
    const errorMessage = document.getElementById('errorMessage');
    const successAlert = document.getElementById('successAlert');
    const successMessage = document.getElementById('successMessage');

    // Verify elements exist
    if (!form || !errorAlert || !errorMessage || !successAlert || !successMessage) {
      console.error('Required elements not found');
      return;
    }

    function showError(message) {
      errorMessage.textContent = message;
      errorAlert.classList.remove('hidden');
      successAlert.classList.add('hidden');
    }

    function showSuccess(message) {
      successMessage.textContent = message;
      successAlert.classList.remove('hidden');
      errorAlert.classList.add('hidden');
    }

    function storeTokens(tokenData) {
      localStorage.setItem('access_token', tokenData.access_token);
      localStorage.setItem('refresh_token', tokenData.refresh_token);
      localStorage.setItem('token_expires', tokenData.expires_at);
      localStorage.setItem('user_id', tokenData.user_id);
      localStorage.setItem('username', tokenData.username);
    }

    // Handle form submission
    form.addEventListener('submit', async function (e) {
      e.preventDefault();

      // Clear previous alerts
      errorAlert.classList.add('hidden');
      successAlert.classList.add('hidden');

      // Get form data
      const formData = {
        username: form.username.value.trim(),
        password: form.password.value
      };

      // Basic validation
      if (!formData.username || !formData.password) {
        showError('Please fill in all fields');
        return;
      }

      try {
        const response = await fetch('/auth/login', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(formData)
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.detail || 'Login failed');
        }

        // Store tokens and user data
        storeTokens(data);

        // Handle remember me
        if (form.remember.checked) {
          localStorage.setItem('remember_login', 'true');
          localStorage.setItem('remembered_username', formData.username);
        } else {
          localStorage.removeItem('remember_login');
          localStorage.removeItem('remembered_username');
        }

        showSuccess('Login successful! Redirecting...');

        // Redirect to dashboard
        setTimeout(() => {
          window.location.href = '/dashboard';
        }, 1000);

      } catch (error) {
        showError(error.message || 'Invalid username or password');
      }
    });

    // Load remembered username if exists
    if (localStorage.getItem('remember_login') === 'true') {
      const rememberedUsername = localStorage.getItem('remembered_username');
      if (rememberedUsername) {
        form.username.value = rememberedUsername;
        form.remember.checked = true;
      }
    }
  });
</script>
{% endblock %}